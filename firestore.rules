rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Applications collection
    match /applications/{applicationId} {

      // READ: Only owner can read their application
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;

      // CREATE: Only owner can create their own application
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;

      // UPDATE: Only owner can update their own document
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;

      // DELETE: Only owner can delete their own application
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;

      // Subcollections: notes, events, etc.
      match /{subcollection}/{document=**} {

        // READ + LIST: Only owner of the parent application
        allow get, list: if request.auth != null
                         && get(/databases/$(database)/documents/applications/$(applicationId)).data.userId == request.auth.uid;

        // CREATE: Only owner of the parent application can create
        allow create: if request.auth != null
                      && get(/databases/$(database)/documents/applications/$(applicationId)).data.userId == request.auth.uid;

        // UPDATE + DELETE: Only owner of the parent application can modify
        allow update, delete: if request.auth != null
                              && get(/databases/$(database)/documents/applications/$(applicationId)).data.userId == request.auth.uid;
      }
    }
  }
}
